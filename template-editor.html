<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁîªÂ∏ÉÁºñËæëÂô® - Canvas Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 0.75rem 2rem;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            z-index: 100;
            flex-shrink: 0;
        }

        .header-content {
            max-width: 100%;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            color: #333;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .main-container {
            flex: 1;
            display: flex;
            min-height: 0;
            overflow: hidden;
        }

        .left-sidebar {
            width: 320px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            overflow-y: auto;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .center-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            padding: 1rem;
        }

        .right-sidebar {
            width: 320px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .canvas-container {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 1rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            position: relative;
            min-height: 0;
        }

        .canvas-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            margin-bottom: 1rem;
            flex-shrink: 0;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .zoom-slider {
            width: 120px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: #ddd;
            border-radius: 2px;
            outline: none;
        }

        .zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #667eea;
            border-radius: 50%;
            cursor: pointer;
        }

        .zoom-value {
            min-width: 45px;
            text-align: center;
            font-size: 0.875rem;
            font-weight: 600;
            color: #667eea;
        }

        .zoom-btn {
            width: 28px;
            height: 28px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .zoom-btn:hover {
            background: #667eea;
            color: white;
        }

        .canvas-viewport {
            flex: 1;
            overflow: auto;
            background: #f5f5f5;
            border-radius: 8px;
            position: relative;
            padding: 20px;
            min-height: 0;
        }

        .canvas-content {
            position: relative;
            display: inline-block;
            transform-origin: top left;
            transition: transform 0.2s ease;
        }

        #canvas-wrapper {
            position: relative;
            background: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 2px solid #e0e0e0;
            overflow: hidden;
        }

        #canvas {
            position: relative;
            width: 100%;
            height: 100%;
            background-color: white;
        }

        .canvas-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0.3;
            background-image: 
                linear-gradient(0deg, #e0e0e0 1px, transparent 1px),
                linear-gradient(90deg, #e0e0e0 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .canvas-element {
            position: absolute;
            cursor: move;
            user-select: none;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }

        .canvas-element:hover {
            border-color: #667eea;
        }

        .canvas-element.selected {
            border-color: #764ba2;
            box-shadow: 0 0 0 2px rgba(118, 75, 162, 0.2);
        }

        .canvas-element.multi-selected {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .canvas-element img {
            width: 100%;
            height: 100%;
            display: block;
            pointer-events: none;
        }

        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 50%;
            display: none;
            z-index: 10;
        }

        .canvas-element.selected .resize-handle {
            display: block;
        }

        .resize-handle.nw { top: -5px; left: -5px; cursor: nw-resize; }
        .resize-handle.ne { top: -5px; right: -5px; cursor: ne-resize; }
        .resize-handle.sw { bottom: -5px; left: -5px; cursor: sw-resize; }
        .resize-handle.se { bottom: -5px; right: -5px; cursor: se-resize; }

        .selection-box {
            position: absolute;
            border: 2px dashed #667eea;
            background: rgba(102, 126, 234, 0.1);
            pointer-events: none;
            z-index: 1000;
        }

        .section {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .input-group {
            margin-bottom: 0.75rem;
        }

        label {
            display: block;
            font-size: 0.875rem;
            color: #555;
            margin-bottom: 0.25rem;
        }

        input[type="number"],
        input[type="file"],
        input[type="text"] {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        input[type="number"]:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-row {
            display: flex;
            gap: 0.5rem;
        }

        .input-row .input-group {
            flex: 1;
        }

        button {
            width: 100%;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        button.secondary:hover {
            background: #f8f9ff;
        }

        button.small {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        button:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .button-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .button-group button {
            flex: 1;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left: 4px solid #10b981;
        }

        .toast.error {
            border-left: 4px solid #ef4444;
        }

        .toast.info {
            border-left: 4px solid #3b82f6;
        }

        .elements-list {
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 0.5rem;
        }

        .element-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.25rem;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        .element-item:hover {
            background: #f3f4f6;
        }

        .element-item.selected {
            background: #ede9fe;
            color: #667eea;
        }

        .element-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            flex: 1;
        }

        .element-layer {
            font-size: 0.75rem;
            color: #999;
            margin-left: auto;
            margin-right: 0.5rem;
        }

        .delete-btn {
            padding: 0.25rem 0.5rem;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .delete-btn:hover {
            background: #dc2626;
        }

        .canvas-info {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-family: monospace;
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .align-tools {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        .align-btn {
            padding: 0.5rem;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .align-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .align-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .properties-panel {
            display: none;
        }

        .properties-panel.active {
            display: block;
        }

        .selection-info {
            background: #f0f4ff;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: #667eea;
            text-align: center;
        }

        .grid-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .toggle-switch {
            position: relative;
            width: 40px;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #667eea;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .toggle-switch.active::after {
            transform: translateX(20px);
        }

        .layer-tools {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .layer-btn {
            padding: 0.5rem;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .layer-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .layer-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .multi-size-controls {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #e0e0e0;
        }

        .snap-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>
                <div class="logo">CE</div>
                ÁîªÂ∏ÉÁºñËæëÂô®
            </h1>
            <div id="datetime"></div>
        </div>
    </header>

    <div class="main-container">
        <aside class="left-sidebar">
            <section class="section">
                <h2 class="section-title">
                    <span>üìê</span> ÁîªÂ∏ÉËÆæÁΩÆ
                </h2>
                <div class="input-row">
                    <div class="input-group">
                        <label for="canvas-width">ÂÆΩÂ∫¶ (px)</label>
                        <input type="number" id="canvas-width" value="1920" min="100" max="4000">
                    </div>
                    <div class="input-group">
                        <label for="canvas-height">È´òÂ∫¶ (px)</label>
                        <input type="number" id="canvas-height" value="1080" min="100" max="4000">
                    </div>
                </div>
                <button onclick="resizeCanvas()">
                    <span>üìê</span> Ë∞ÉÊï¥ÁîªÂ∏ÉÂ§ßÂ∞è
                </button>
            </section>

            <section class="section">
                <h2 class="section-title">
                    <span>üñºÔ∏è</span> Ê∑ªÂä†ÂõæÁâá
                </h2>
                <input type="file" id="image-input" accept="image/*" multiple style="display: none;">
                <button onclick="document.getElementById('image-input').click()">
                    <span>üìÅ</span> ÈÄâÊã©ÂõæÁâáÊñá‰ª∂
                </button>
            </section>

            <section class="section">
                <h2 class="section-title">
                    <span>üìã</span> ÂÖÉÁ¥†ÂàóË°®
                </h2>
                <div class="elements-list" id="elements-list">
                    <p style="color: #999; text-align: center; padding: 1rem;">ÊöÇÊó†ÂÖÉÁ¥†</p>
                </div>
            </section>

            <section class="section">
                <h2 class="section-title">
                    <span>üíæ</span> Êï∞ÊçÆÁÆ°ÁêÜ
                </h2>
                <div class="button-group">
                    <button onclick="exportJSON()" class="secondary small">
                        <span>‚¨áÔ∏è</span> ÂØºÂá∫JSON
                    </button>
                    <button onclick="document.getElementById('json-input').click()" class="secondary small">
                        <span>‚¨ÜÔ∏è</span> ÂØºÂÖ•JSON
                    </button>
                </div>
                <input type="file" id="json-input" accept=".json" style="display: none;">
            </section>

            <section class="section">
                <h2 class="section-title">
                    <span>üì∏</span> ÂØºÂá∫ÁîªÂ∏É
                </h2>
                <button onclick="exportCanvas()">
                    <span>üñºÔ∏è</span> ÂØºÂá∫‰∏∫ÂõæÁâá
                </button>
            </section>

            <section class="section">
                <h2 class="section-title">
                    <span>üóëÔ∏è</span> Âø´Êç∑Êìç‰Ωú
                </h2>
                <div class="button-group">
                    <button onclick="clearCanvas()" class="secondary small">
                        <span>üóëÔ∏è</span> Ê∏ÖÁ©∫
                    </button>
                    <button onclick="deleteSelected()" class="secondary small">
                        <span>‚ùå</span> Âà†Èô§
                    </button>
                </div>
            </section>
        </aside>

        <div class="center-area">
            <div class="canvas-container">
                <div class="canvas-toolbar">
                    <div class="canvas-info">
                        <div class="info-item">
                            <span>üìê</span>
                            <span id="canvas-size">1920 x 1080</span>
                        </div>
                        <div class="info-item">
                            <span>üîç</span>
                            <span id="zoom-info">100%</span>
                        </div>
                        <div class="info-item">
                            <span>üì¶</span>
                            <span id="selection-count">0 ‰∏™ÈÄâ‰∏≠</span>
                        </div>
                    </div>
                    <div class="zoom-controls">
                        <button class="zoom-btn" onclick="zoomOut()">‚àí</button>
                        <input type="range" class="zoom-slider" id="zoom-slider" min="10" max="200" value="100" step="5">
                        <button class="zoom-btn" onclick="zoomIn()">+</button>
                        <div class="zoom-value" id="zoom-value">100%</div>
                        <button class="zoom-btn" onclick="fitToScreen()" title="ÈÄÇÂ∫îÂ±èÂπï">‚ä°</button>
                        <button class="zoom-btn" onclick="resetZoom()" title="ÈáçÁΩÆÁº©Êîæ">‚ü≤</button>
                    </div>
                </div>
                <div class="canvas-viewport" id="canvas-viewport">
                    <div class="canvas-content" id="canvas-content">
                        <div id="canvas-wrapper">
                            <div id="canvas" style="width: 1920px; height: 1080px;">
                                <div class="canvas-grid" id="canvas-grid"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <aside class="right-sidebar">
            <section class="section">
                <h2 class="section-title">
                    <span>üéØ</span> ÂØπÈΩêÂ∑•ÂÖ∑
                </h2>
                <div class="selection-info" id="selection-info" style="display: none;">
                    Â∑≤ÈÄâÊã© <span id="multi-select-count">0</span> ‰∏™ÂÖÉÁ¥†
                </div>
                <div class="align-tools">
                    <button class="align-btn" onclick="alignLeft()" title="Â∑¶ÂØπÈΩê" id="align-left-btn" disabled>
                        ‚¨ÖÔ∏è
                    </button>
                    <button class="align-btn" onclick="alignCenter()" title="Ê∞¥Âπ≥Â±Ö‰∏≠" id="align-center-btn" disabled>
                        ‚ÜîÔ∏è
                    </button>
                    <button class="align-btn" onclick="alignRight()" title="Âè≥ÂØπÈΩê" id="align-right-btn" disabled>
                        ‚û°Ô∏è
                    </button>
                    <button class="align-btn" onclick="alignTop()" title="È°∂ÂØπÈΩê" id="align-top-btn" disabled>
                        ‚¨ÜÔ∏è
                    </button>
                    <button class="align-btn" onclick="alignMiddle()" title="ÂûÇÁõ¥Â±Ö‰∏≠" id="align-middle-btn" disabled>
                        ‚ÜïÔ∏è
                    </button>
                    <button class="align-btn" onclick="alignBottom()" title="Â∫ïÂØπÈΩê" id="align-bottom-btn" disabled>
                        ‚¨áÔ∏è
                    </button>
                    <button class="align-btn" onclick="distributeHorizontal()" title="Ê∞¥Âπ≥ÂàÜÂ∏É" id="distribute-h-btn" disabled>
                        üìè‚ÜîÔ∏è
                    </button>
                    <button class="align-btn" onclick="distributeVertical()" title="ÂûÇÁõ¥ÂàÜÂ∏É" id="distribute-v-btn" disabled>
                        üìè‚ÜïÔ∏è
                    </button>
                    <button class="align-btn" onclick="alignToCanvas()" title="ÂØπÈΩêÂà∞ÁîªÂ∏É" id="align-canvas-btn" disabled>
                        üéØ
                    </button>
                </div>
            </section>

            <section class="section">
                <h2 class="section-title">
                    <span>üìö</span> ÂõæÂ±ÇÁÆ°ÁêÜ
                </h2>
                <div class="layer-tools">
                    <button class="layer-btn" onclick="moveLayerUp()" title="‰∏äÁßª‰∏ÄÂ±Ç" id="layer-up-btn" disabled>
                        <span>‚¨ÜÔ∏è</span> ‰∏äÁßª
                    </button>
                    <button class="layer-btn" onclick="moveLayerDown()" title="‰∏ãÁßª‰∏ÄÂ±Ç" id="layer-down-btn" disabled>
                        <span>‚¨áÔ∏è</span> ‰∏ãÁßª
                    </button>
                    <button class="layer-btn" onclick="moveLayerTop()" title="ÁΩÆ‰∫éÈ°∂Â±Ç" id="layer-top-btn" disabled>
                        <span>‚¨ÜÔ∏è</span> ÁΩÆÈ°∂
                    </button>
                    <button class="layer-btn" onclick="moveLayerBottom()" title="ÁΩÆ‰∫éÂ∫ïÂ±Ç" id="layer-bottom-btn" disabled>
                        <span>‚¨áÔ∏è</span> ÁΩÆÂ∫ï
                    </button>
                </div>
            </section>

            <section class="section">
                <h2 class="section-title">
                    <span>‚öôÔ∏è</span> ÊòæÁ§∫ËÆæÁΩÆ
                </h2>
                <div class="grid-toggle">
                    <label>ÊòæÁ§∫ÁΩëÊ†º</label>
                    <div class="toggle-switch active" id="grid-toggle" onclick="toggleGrid()"></div>
                </div>
                <div class="snap-toggle">
                    <label>ÁΩëÊ†ºÊçïÊçâ</label>
                    <div class="toggle-switch active" id="snap-toggle" onclick="toggleSnap()"></div>
                </div>
                <div class="input-group">
                    <label for="grid-size">ÁΩëÊ†ºÂ§ßÂ∞è (px)</label>
                    <input type="number" id="grid-size" value="20" min="10" max="100" onchange="updateGridSize()">
                </div>
            </section>

            <!-- ‰øÆÂ§çÂêéÁöÑÂ±ûÊÄßÈù¢ÊùøHTMLÁªìÊûÑ -->
            <section class="section properties-panel" id="properties-panel">
                <h2 class="section-title">
                    <span>‚öôÔ∏è</span> Â±ûÊÄßÈù¢Êùø
                </h2>
                <div class="input-row">
                    <div class="input-group">
                        <label for="prop-x">X ÂùêÊ†á</label>
                        <input type="number" id="prop-x" onchange="updateElementProperties()">
                    </div>
                    <div class="input-group">
                        <label for="prop-y">Y ÂùêÊ†á</label>
                        <input type="number" id="prop-y" onchange="updateElementProperties()">
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label for="prop-width">ÂÆΩÂ∫¶</label>
                        <input type="number" id="prop-width" min="10" onchange="updateElementProperties()">
                    </div>
                    <div class="input-group">
                        <label for="prop-height">È´òÂ∫¶</label>
                        <input type="number" id="prop-height" min="10" onchange="updateElementProperties()">
                    </div>
                </div>
                <div class="multi-size-controls">
                    <button onclick="applySizeToAllSelected()" id="apply-size-btn" disabled>
                        <span>üìê</span> Â∫îÁî®Âà∞ÊâÄÊúâÈÄâ‰∏≠
                    </button>
                </div>
            </section>
        </aside>
    </div>

    <div id="toast" class="toast">
        <span id="toast-icon"></span>
        <span id="toast-message"></span>
    </div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let canvasElements = [];
        let selectedElements = [];
        let isDragging = false;
        let isResizing = false;
        let isBoxSelecting = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let elementStartX = 0;
        let elementStartY = 0;
        let resizeHandle = null;
        let elementIdCounter = 0;
        let currentZoom = 100;
        let canvasScale = 1;
        let gridVisible = true;
        let gridSize = 20;
        let maxZIndex = 0;
        let selectionBox = null;
        let boxSelectedElements = []; // ‰øÆÂ§çÔºö‰øùÂ≠òÊ°ÜÈÄâÁöÑÂÖÉÁ¥†
        let snapToGrid = true; // Êñ∞Â¢ûÔºöÁΩëÊ†ºÊçïÊçâÂºÄÂÖ≥

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // ÁªëÂÆö‰∫ã‰ª∂
            document.getElementById('image-input').addEventListener('change', handleImageUpload);
            document.getElementById('json-input').addEventListener('change', handleJSONImport);
            document.getElementById('zoom-slider').addEventListener('input', handleZoomChange);
            
            // ÁîªÂ∏ÉÁÇπÂáª‰∫ã‰ª∂
            document.getElementById('canvas').addEventListener('click', function(e) {
                if (e.target.id === 'canvas' || e.target.id === 'canvas-grid') {
                    deselectAll();
                }
            });

            // ÂÖ®Â±ÄÈº†Ê†á‰∫ã‰ª∂
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);

            // ÈîÆÁõò‰∫ã‰ª∂
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Delete') {
                    deleteSelected();
                }
                if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
                    e.preventDefault();
                    selectAll();
                }
                // Ctrl/Cmd + 0 ÈáçÁΩÆÁº©Êîæ
                if ((e.ctrlKey || e.metaKey) && e.key === '0') {
                    e.preventDefault();
                    resetZoom();
                }
                // Ctrl/Cmd + Âä†Âè∑/ÂáèÂè∑Áº©Êîæ
                if ((e.ctrlKey || e.metaKey) && (e.key === '+' || e.key === '=')) {
                    e.preventDefault();
                    zoomIn();
                }
                if ((e.ctrlKey || e.metaKey) && e.key === '-') {
                    e.preventDefault();
                    zoomOut();
                }
                // ÂõæÂ±ÇÂø´Êç∑ÈîÆ
                if (e.ctrlKey || e.metaKey) {
                    if (e.key === ']') {
                        e.preventDefault();
                        moveLayerUp();
                    }
                    if (e.key === '[') {
                        e.preventDefault();
                        moveLayerDown();
                    }
                }
            });

            // Èº†Ê†áÊªöËΩÆÁº©Êîæ
            document.getElementById('canvas-viewport').addEventListener('wheel', function(e) {
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? -5 : 5;
                    const newZoom = Math.max(10, Math.min(200, currentZoom + delta));
                    setZoom(newZoom);
                }
            });

            // Ê°ÜÈÄâÂºÄÂßã
            document.getElementById('canvas').addEventListener('mousedown', function(e) {
                if (e.target.id === 'canvas' || e.target.id === 'canvas-grid') {
                    if (!e.ctrlKey && !e.metaKey) {
                        startBoxSelection(e);
                    }
                }
            });

            // ÂàùÂßãÈÄÇÂ∫îÂ±èÂπï
            setTimeout(fitToScreen, 100);
        });

        // Êõ¥Êñ∞Êó∂Èó¥ÊòæÁ§∫
        function updateDateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                weekday: 'long'
            });
            const timeStr = now.toLocaleTimeString('zh-CN');
            document.getElementById('datetime').textContent = `${dateStr} ${timeStr}`;
        }

        // Áº©ÊîæÂäüËÉΩ
        function handleZoomChange(e) {
            setZoom(parseInt(e.target.value));
        }

        function setZoom(zoom) {
            currentZoom = zoom;
            canvasScale = zoom / 100;
            
            const content = document.getElementById('canvas-content');
            content.style.transform = `scale(${canvasScale})`;
            
            document.getElementById('zoom-slider').value = zoom;
            document.getElementById('zoom-value').textContent = zoom + '%';
            document.getElementById('zoom-info').textContent = zoom + '%';
            
            // Êõ¥Êñ∞ÁΩëÊ†ºÂ§ßÂ∞è‰ª•‰øùÊåÅËßÜËßâ‰∏ÄËá¥ÊÄß
            updateGridDisplay();
        }

        function updateGridDisplay() {
            const grid = document.getElementById('canvas-grid');
            if (gridVisible) {
                // ‰øÆÂ§çÔºöÁ°Æ‰øùÁΩëÊ†ºÂ§ßÂ∞èËÉΩÊï¥Èô§ÁîªÂ∏ÉÂ∞∫ÂØ∏
                const canvas = document.getElementById('canvas');
                const canvasWidth = parseInt(canvas.style.width);
                const canvasHeight = parseInt(canvas.style.height);
                
                // ËÆ°ÁÆóËÉΩÊï¥Èô§ÁîªÂ∏ÉÂ∞∫ÂØ∏ÁöÑÊúÄ‰Ω≥ÁΩëÊ†ºÂ§ßÂ∞è
                const optimalGridSize = calculateOptimalGridSize(gridSize, canvasWidth, canvasHeight);
                
                grid.style.backgroundSize = `${optimalGridSize}px ${optimalGridSize}px`;
            }
        }

        // ‰øÆÂ§çÔºöËÆ°ÁÆóËÉΩÊï¥Èô§ÁîªÂ∏ÉÂ∞∫ÂØ∏ÁöÑÊúÄ‰Ω≥ÁΩëÊ†ºÂ§ßÂ∞è
        function calculateOptimalGridSize(desiredSize, canvasWidth, canvasHeight) {
            // ÊâæÂà∞ÊúÄÊé•ËøëdesiredSize‰∏îËÉΩÂêåÊó∂Êï¥Èô§ÁîªÂ∏ÉÂÆΩÂ∫¶ÂíåÈ´òÂ∫¶ÁöÑÂÄº
            let bestSize = desiredSize;
            
            // Ê£ÄÊü•desiredSizeÊòØÂê¶ËÉΩÊï¥Èô§ÁîªÂ∏ÉÂ∞∫ÂØ∏
            if (canvasWidth % desiredSize === 0 && canvasHeight % desiredSize === 0) {
                return desiredSize;
            }
            
            // Â¶ÇÊûú‰∏çËÉΩÔºåÂ∞ùËØïÊâæÂà∞ÊúÄÊé•ËøëÁöÑËÉΩÊï¥Èô§ÁöÑÂÄº
            for (let i = desiredSize; i >= 10; i--) {
                if (canvasWidth % i === 0 && canvasHeight % i === 0) {
                    bestSize = i;
                    break;
                }
            }
            
            // Â¶ÇÊûú‰ªçÁÑ∂Êâæ‰∏çÂà∞ÔºåÂ∞ùËØïÂêë‰∏äÊâæ
            if (bestSize === desiredSize) {
                for (let i = desiredSize; i <= 100; i++) {
                    if (canvasWidth % i === 0 && canvasHeight % i === 0) {
                        bestSize = i;
                        break;
                    }
                }
            }
            
            return bestSize;
        }

        function zoomIn() {
            const newZoom = Math.min(200, currentZoom + 10);
            setZoom(newZoom);
        }

        function zoomOut() {
            const newZoom = Math.max(10, currentZoom - 10);
            setZoom(newZoom);
        }

        function resetZoom() {
            setZoom(100);
            showToast('Áº©ÊîæÂ∑≤ÈáçÁΩÆ', 'info');
        }

        function fitToScreen() {
            const viewport = document.getElementById('canvas-viewport');
            const canvas = document.getElementById('canvas');
            const viewportWidth = viewport.clientWidth - 40;
            const viewportHeight = viewport.clientHeight - 40;
            
            const scaleX = (viewportWidth / canvas.offsetWidth) * 100;
            const scaleY = (viewportHeight / canvas.offsetHeight) * 100;
            const fitZoom = Math.min(scaleX, scaleY, 100);
            
            setZoom(Math.max(10, Math.floor(fitZoom)));
            showToast('ÁîªÂ∏ÉÂ∑≤ÈÄÇÂ∫îÂ±èÂπï', 'info');
        }

        // ÁΩëÊ†ºÊéßÂà∂
        function toggleGrid() {
            gridVisible = !gridVisible;
            const toggle = document.getElementById('grid-toggle');
            const grid = document.getElementById('canvas-grid');
            
            if (gridVisible) {
                toggle.classList.add('active');
                grid.style.display = 'block';
                updateGridDisplay();
            } else {
                toggle.classList.remove('active');
                grid.style.display = 'none';
            }
        }

        // Êñ∞Â¢ûÔºöÁΩëÊ†ºÊçïÊçâÂºÄÂÖ≥
        function toggleSnap() {
            snapToGrid = !snapToGrid;
            const toggle = document.getElementById('snap-toggle');
            
            if (snapToGrid) {
                toggle.classList.add('active');
                showToast('ÁΩëÊ†ºÊçïÊçâÂ∑≤ÂºÄÂêØ', 'info');
            } else {
                toggle.classList.remove('active');
                showToast('ÁΩëÊ†ºÊçïÊçâÂ∑≤ÂÖ≥Èó≠', 'info');
            }
        }

        function updateGridSize() {
            gridSize = parseInt(document.getElementById('grid-size').value);
            updateGridDisplay();
        }

        // Êñ∞Â¢ûÔºöÁΩëÊ†ºÊçïÊçâÂäüËÉΩ
        function snapToGridPoint(value) {
            if (!snapToGrid) return value;
            
            // ËÆ°ÁÆóÊúÄËøëÁöÑÁΩëÊ†ºÁÇπ
            const gridPoint = Math.round(value / gridSize) * gridSize;
            return gridPoint;
        }

        // Ë∞ÉÊï¥ÁîªÂ∏ÉÂ§ßÂ∞è
        function resizeCanvas() {
            const width = parseInt(document.getElementById('canvas-width').value);
            const height = parseInt(document.getElementById('canvas-height').value);
            
            if (width < 100 || width > 4000 || height < 100 || height > 4000) {
                showToast('ÁîªÂ∏ÉÂ∞∫ÂØ∏ÂøÖÈ°ªÂú® 100-4000 ÂÉèÁ¥†‰πãÈó¥', 'error');
                return;
            }

            const canvas = document.getElementById('canvas');
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
            
            document.getElementById('canvas-size').textContent = `${width} x ${height}`;
            
            // Êõ¥Êñ∞ÁΩëÊ†ºÊòæÁ§∫
            updateGridDisplay();
            
            setTimeout(fitToScreen, 100);
            showToast('ÁîªÂ∏ÉÂ§ßÂ∞èÂ∑≤Ë∞ÉÊï¥', 'success');
        }

        // Â§ÑÁêÜÂõæÁâá‰∏ä‰º†
        function handleImageUpload(e) {
            const files = e.target.files;
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        addImageToCanvas(event.target.result, file.name);
                    };
                    reader.readAsDataURL(file);
                }
            }
            e.target.value = '';
        }

        // Ê∑ªÂä†ÂõæÁâáÂà∞ÁîªÂ∏É
        function addImageToCanvas(src, name) {
            const canvas = document.getElementById('canvas');
            const element = document.createElement('div');
            element.className = 'canvas-element';
            element.id = 'element-' + (++elementIdCounter);
            
            const img = new Image();
            img.onload = function() {
                // ‰øùÂ≠òÂéüÂßãÂ∞∫ÂØ∏
                const originalWidth = img.width;
                const originalHeight = img.height;
                
                let width = originalWidth;
                let height = originalHeight;
                const maxSize = Math.min(canvas.offsetWidth, canvas.offsetHeight) * 0.3;
                
                if (width > maxSize || height > maxSize) {
                    const ratio = Math.min(maxSize / width, maxSize / height);
                    width *= ratio;
                    height *= ratio;
                }
                
                element.style.width = width + 'px';
                element.style.height = height + 'px';
                element.style.left = Math.random() * (canvas.offsetWidth - width) + 'px';
                element.style.top = Math.random() * (canvas.offsetHeight - height) + 'px';
                element.style.zIndex = ++maxZIndex;
                
                element.innerHTML = `
                    <img src="${src}" alt="${name}">
                    <div class="resize-handle nw"></div>
                    <div class="resize-handle ne"></div>
                    <div class="resize-handle sw"></div>
                    <div class="resize-handle se"></div>
                `;
                
                canvas.appendChild(element);
                
                const elementData = {
                    id: element.id,
                    src: src,
                    name: name,
                    originalName: name,
                    x: parseInt(element.style.left),
                    y: parseInt(element.style.top),
                    width: width,
                    height: height,
                    originalWidth: originalWidth,
                    originalHeight: originalHeight,
                    zIndex: maxZIndex,
                    canvasWidth: parseInt(canvas.style.width),
                    canvasHeight: parseInt(canvas.style.height)
                };
                canvasElements.push(elementData);
                
                bindElementEvents(element);
                
                updateElementsList();
                showToast(`Â∑≤Ê∑ªÂä†ÂõæÁâá: ${name}`, 'success');
            };
            img.src = src;
        }

        // ÁªëÂÆöÂÖÉÁ¥†‰∫ã‰ª∂
        function bindElementEvents(element) {
            element.addEventListener('mousedown', function(e) {
                if (e.target.classList.contains('resize-handle')) {
                    startResize(e, element);
                } else if (e.target.tagName === 'IMG' || e.target === element) {
                    startDrag(e, element);
                }
            });
            
            element.addEventListener('click', function(e) {
                e.stopPropagation();
                if (e.ctrlKey || e.metaKey) {
                    toggleElementSelection(element);
                } else {
                    selectElement(element);
                }
            });
        }

        // Ê°ÜÈÄâÂäüËÉΩ - ‰øÆÂ§çÂêéÁöÑÁâàÊú¨
        function startBoxSelection(e) {
            isBoxSelecting = true;
            deselectAll();
            boxSelectedElements = []; // Ê∏ÖÁ©∫Ê°ÜÈÄâÁºìÂ≠ò
            
            const canvasRect = document.getElementById('canvas').getBoundingClientRect();
            dragStartX = (e.clientX - canvasRect.left) / canvasScale;
            dragStartY = (e.clientY - canvasRect.top) / canvasScale;
            
            // ÂàõÂª∫ÈÄâÊã©Ê°Ü
            selectionBox = document.createElement('div');
            selectionBox.className = 'selection-box';
            selectionBox.style.left = dragStartX + 'px';
            selectionBox.style.top = dragStartY + 'px';
            selectionBox.style.width = '0px';
            selectionBox.style.height = '0px';
            
            document.getElementById('canvas').appendChild(selectionBox);
            
            e.preventDefault();
        }

        // ÂºÄÂßãÊãñÊãΩ
        function startDrag(e, element) {
            isDragging = true;
            
            if (!e.ctrlKey && !e.metaKey && !selectedElements.includes(element)) {
                selectElement(element);
            }
            
            const rect = element.getBoundingClientRect();
            const canvasRect = document.getElementById('canvas').getBoundingClientRect();
            
            dragStartX = (e.clientX - canvasRect.left) / canvasScale;
            dragStartY = (e.clientY - canvasRect.top) / canvasScale;
            
            selectedElements.forEach(el => {
                el.dataset.startX = parseInt(el.style.left);
                el.dataset.startY = parseInt(el.style.top);
            });
            
            e.preventDefault();
        }

        // ÂºÄÂßãË∞ÉÊï¥Â§ßÂ∞è
        function startResize(e, element) {
            isResizing = true;
            selectedElement = element;
            resizeHandle = e.target.className.split(' ')[1];
            
            const canvasRect = document.getElementById('canvas').getBoundingClientRect();
            
            dragStartX = (e.clientX - canvasRect.left) / canvasScale;
            dragStartY = (e.clientY - canvasRect.top) / canvasScale;
            elementStartX = parseInt(element.style.left);
            elementStartY = parseInt(element.style.top);
            elementStartWidth = parseInt(element.style.width);
            elementStartHeight = parseInt(element.style.height);
            
            e.preventDefault();
            e.stopPropagation();
        }

        // Â§ÑÁêÜÈº†Ê†áÁßªÂä® - ‰øÆÂ§çÂêéÁöÑÁâàÊú¨
        function handleMouseMove(e) {
            // Ê°ÜÈÄâÁßªÂä®
            if (isBoxSelecting && selectionBox) {
                const canvasRect = document.getElementById('canvas').getBoundingClientRect();
                const currentX = (e.clientX - canvasRect.left) / canvasScale;
                const currentY = (e.clientY - canvasRect.top) / canvasScale;
                
                const left = Math.min(dragStartX, currentX);
                const top = Math.min(dragStartY, currentY);
                const width = Math.abs(currentX - dragStartX);
                const height = Math.abs(currentY - dragStartY);
                
                selectionBox.style.left = left + 'px';
                selectionBox.style.top = top + 'px';
                selectionBox.style.width = width + 'px';
                selectionBox.style.height = height + 'px';
                
                // ‰øÆÂ§çÔºöÊ£ÄÊü•Ê°ÜÈÄâËåÉÂõ¥ÂÜÖÁöÑÂÖÉÁ¥†
                const elements = document.querySelectorAll('.canvas-element');
                elements.forEach(element => {
                    // ‰øÆÂ§çÔºöÁõ¥Êé•‰ΩøÁî®ÂÖÉÁ¥†ÁöÑoffsetLeftÂíåoffsetTop
                    const elLeft = element.offsetLeft;
                    const elTop = element.offsetTop;
                    const elRight = elLeft + element.offsetWidth;
                    const elBottom = elTop + element.offsetHeight;
                    
                    // Ê£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶Âú®ÈÄâÊã©Ê°ÜÂÜÖ
                    if (elLeft >= left && elTop >= top && elRight <= left + width && elBottom <= top + height) {
                        if (!boxSelectedElements.includes(element)) {
                            boxSelectedElements.push(element);
                            element.classList.add('selected');
                        }
                    } else {
                        // Â¶ÇÊûúÂÖÉÁ¥†‰∏çÂú®ÈÄâÊã©Ê°ÜÂÜÖÔºå‰ªéÊ°ÜÈÄâÁºìÂ≠ò‰∏≠ÁßªÈô§
                        const index = boxSelectedElements.indexOf(element);
                        if (index > -1) {
                            boxSelectedElements.splice(index, 1);
                            element.classList.remove('selected');
                        }
                    }
                });
            }
            
            // ÊãñÊãΩÁßªÂä®
            if (isDragging && selectedElements.length > 0) {
                const canvasRect = document.getElementById('canvas').getBoundingClientRect();
                const currentX = (e.clientX - canvasRect.left) / canvasScale;
                const currentY = (e.clientY - canvasRect.top) / canvasScale;
                
                const dx = currentX - dragStartX;
                const dy = currentY - dragStartY;
                
                selectedElements.forEach(element => {
                    const startX = parseInt(element.dataset.startX);
                    const startY = parseInt(element.dataset.startY);
                    
                    let newX = startX + dx;
                    let newY = startY + dy;
                    
                    // Êñ∞Â¢ûÔºöÂ∫îÁî®ÁΩëÊ†ºÊçïÊçâ
                    if (snapToGrid) {
                        newX = snapToGridPoint(newX);
                        newY = snapToGridPoint(newY);
                    }
                    
                    const canvas = document.getElementById('canvas');
                    newX = Math.max(0, Math.min(newX, canvas.offsetWidth - element.offsetWidth));
                    newY = Math.max(0, Math.min(newY, canvas.offsetHeight - element.offsetHeight));
                    
                    element.style.left = newX + 'px';
                    element.style.top = newY + 'px';
                });
            }
            
            // Ë∞ÉÊï¥Â§ßÂ∞è
            if (isResizing && selectedElement) {
                const canvasRect = document.getElementById('canvas').getBoundingClientRect();
                const currentX = (e.clientX - canvasRect.left) / canvasScale;
                const currentY = (e.clientY - canvasRect.top) / canvasScale;
                
                const dx = currentX - dragStartX;
                const dy = currentY - dragStartY;
                
                let newWidth = elementStartWidth;
                let newHeight = elementStartHeight;
                let newX = elementStartX;
                let newY = elementStartY;
                
                switch(resizeHandle) {
                    case 'se':
                        newWidth = elementStartWidth + dx;
                        newHeight = elementStartHeight + dy;
                        break;
                    case 'sw':
                        newWidth = elementStartWidth - dx;
                        newHeight = elementStartHeight + dy;
                        newX = elementStartX + dx;
                        break;
                    case 'ne':
                        newWidth = elementStartWidth + dx;
                        newHeight = elementStartHeight - dy;
                        newY = elementStartY + dy;
                        break;
                    case 'nw':
                        newWidth = elementStartWidth - dx;
                        newHeight = elementStartHeight - dy;
                        newX = elementStartX + dx;
                        newY = elementStartY + dy;
                        break;
                }
                
                // Êñ∞Â¢ûÔºöË∞ÉÊï¥Â§ßÂ∞èÊó∂‰πüÂ∫îÁî®ÁΩëÊ†ºÊçïÊçâ
                if (snapToGrid) {
                    newWidth = snapToGridPoint(newWidth);
                    newHeight = snapToGridPoint(newHeight);
                    newX = snapToGridPoint(newX);
                    newY = snapToGridPoint(newY);
                }
                
                if (newWidth >= 50) {
                    selectedElement.style.width = newWidth + 'px';
                    selectedElement.style.left = newX + 'px';
                }
                if (newHeight >= 50) {
                    selectedElement.style.height = newHeight + 'px';
                    selectedElement.style.top = newY + 'px';
                }
            }
        }

        // Â§ÑÁêÜÈº†Ê†áÈáäÊîæ - ‰øÆÂ§çÂêéÁöÑÁâàÊú¨
        function handleMouseUp() {
            if (isBoxSelecting) {
                // ÁßªÈô§ÈÄâÊã©Ê°Ü
                if (selectionBox) {
                    selectionBox.remove();
                    selectionBox = null;
                }
                isBoxSelecting = false;
                
                // ‰øÆÂ§çÔºöÂ∞ÜÊ°ÜÈÄâÁöÑÂÖÉÁ¥†ËÆæÁΩÆ‰∏∫Ê≠£ÂºèÈÄâ‰∏≠
                selectedElements = [...boxSelectedElements];
                boxSelectedElements = [];
                
                // Á°Æ‰øùÊ°ÜÈÄâÁöÑÂÖÉÁ¥†‰øùÊåÅÈÄâ‰∏≠Áä∂ÊÄÅ
                updateSelectionUI();
            }
            
            if (isDragging || isResizing) {
                updateElementsData();
                updatePropertiesPanel();
            }
            isDragging = false;
            isResizing = false;
            resizeHandle = null;
        }

        // ÈÄâÊã©ÂÖÉÁ¥†
        function selectElement(element) {
            deselectAll();
            element.classList.add('selected');
            selectedElements = [element];
            updateSelectionUI();
        }

        // ÂàáÊç¢ÂÖÉÁ¥†ÈÄâÊã©
        function toggleElementSelection(element) {
            const index = selectedElements.indexOf(element);
            if (index > -1) {
                selectedElements.splice(index, 1);
                element.classList.remove('selected');
            } else {
                selectedElements.push(element);
                element.classList.add('selected');
            }
            updateSelectionUI();
        }

        // ÈÄâÊã©ÊâÄÊúâÂÖÉÁ¥†
        function selectAll() {
            const elements = document.querySelectorAll('.canvas-element');
            elements.forEach(el => {
                el.classList.add('selected');
                if (!selectedElements.includes(el)) {
                    selectedElements.push(el);
                }
            });
            updateSelectionUI();
        }

        // ÂèñÊ∂àÊâÄÊúâÈÄâ‰∏≠
        function deselectAll() {
            document.querySelectorAll('.canvas-element').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelectorAll('.element-item').forEach(item => {
                item.classList.remove('selected');
            });
            selectedElements = [];
            boxSelectedElements = []; // Ê∏ÖÁ©∫Ê°ÜÈÄâÁºìÂ≠ò
            updateSelectionUI();
        }

        // Êõ¥Êñ∞ÈÄâÊã©UI
        function updateSelectionUI() {
            const count = selectedElements.length;
            document.getElementById('selection-count').textContent = count + ' ‰∏™ÈÄâ‰∏≠';
            document.getElementById('multi-select-count').textContent = count;
            
            // Êõ¥Êñ∞ÂØπÈΩêÂ∑•ÂÖ∑Áä∂ÊÄÅ
            const alignButtons = document.querySelectorAll('.align-btn');
            alignButtons.forEach(btn => btn.disabled = count < 2);
            
            // Êõ¥Êñ∞ÂõæÂ±ÇÂ∑•ÂÖ∑Áä∂ÊÄÅ
            const layerButtons = document.querySelectorAll('.layer-btn');
            layerButtons.forEach(btn => btn.disabled = count === 0);
            
            // Êõ¥Êñ∞Â±ûÊÄßÈù¢ÊùøÁä∂ÊÄÅ
            if (count === 1) {
                document.getElementById('properties-panel').classList.add('active');
                updatePropertiesPanel();
            } else if (count > 1) {
                document.getElementById('properties-panel').classList.add('active');
                updatePropertiesPanel();
            } else {
                document.getElementById('properties-panel').classList.remove('active');
            }
            
            // Êõ¥Êñ∞Â∫îÁî®Âà∞ÊâÄÊúâÈÄâ‰∏≠ÊåâÈíÆÁä∂ÊÄÅ
            document.getElementById('apply-size-btn').disabled = count <= 1;
            
            updateElementsList();
        }

        // Êõ¥Êñ∞Â±ûÊÄßÈù¢Êùø
        function updatePropertiesPanel() {
            if (selectedElements.length === 1) {
                const element = selectedElements[0];
                document.getElementById('prop-x').value = parseInt(element.style.left);
                document.getElementById('prop-y').value = parseInt(element.style.top);
                document.getElementById('prop-width').value = parseInt(element.style.width);
                document.getElementById('prop-height').value = parseInt(element.style.height);
            } else if (selectedElements.length > 1) {
                // Â§öÈÄâÊó∂ÊòæÁ§∫Á¨¨‰∏Ä‰∏™ÂÖÉÁ¥†ÁöÑÂÄº
                const element = selectedElements[0];
                document.getElementById('prop-x').value = parseInt(element.style.left);
                document.getElementById('prop-y').value = parseInt(element.style.top);
                document.getElementById('prop-width').value = parseInt(element.style.width);
                document.getElementById('prop-height').value = parseInt(element.style.height);
            }
        }

        // Êõ¥Êñ∞ÂÖÉÁ¥†Â±ûÊÄß
        function updateElementProperties() {
            if (selectedElements.length === 1) {
                const element = selectedElements[0];
                let x = parseInt(document.getElementById('prop-x').value);
                let y = parseInt(document.getElementById('prop-y').value);
                let width = parseInt(document.getElementById('prop-width').value);
                let height = parseInt(document.getElementById('prop-height').value);
                
                // Êñ∞Â¢ûÔºöÂ∫îÁî®ÁΩëÊ†ºÊçïÊçâ
                if (snapToGrid) {
                    x = snapToGridPoint(x);
                    y = snapToGridPoint(y);
                    width = snapToGridPoint(width);
                    height = snapToGridPoint(height);
                    
                    // Êõ¥Êñ∞ËæìÂÖ•Ê°ÜÊòæÁ§∫ÊçïÊçâÂêéÁöÑÂÄº
                    document.getElementById('prop-x').value = x;
                    document.getElementById('prop-y').value = y;
                    document.getElementById('prop-width').value = width;
                    document.getElementById('prop-height').value = height;
                }
                
                element.style.left = x + 'px';
                element.style.top = y + 'px';
                element.style.width = width + 'px';
                element.style.height = height + 'px';
                updateElementsData();
            }
        }

        // Â∫îÁî®Â∞∫ÂØ∏Âà∞ÊâÄÊúâÈÄâ‰∏≠
        function applySizeToAllSelected() {
            if (selectedElements.length > 1) {
                let width = parseInt(document.getElementById('prop-width').value);
                let height = parseInt(document.getElementById('prop-height').value);
                
                // Êñ∞Â¢ûÔºöÂ∫îÁî®ÁΩëÊ†ºÊçïÊçâ
                if (snapToGrid) {
                    width = snapToGridPoint(width);
                    height = snapToGridPoint(height);
                }
                
                selectedElements.forEach(element => {
                    element.style.width = width + 'px';
                    element.style.height = height + 'px';
                });
                
                updateElementsData();
                showToast('Â∞∫ÂØ∏Â∑≤Â∫îÁî®Âà∞ÊâÄÊúâÈÄâ‰∏≠ÂÖÉÁ¥†', 'success');
            }
        }

        // ÂõæÂ±ÇÁÆ°ÁêÜÂäüËÉΩ
        function moveLayerUp() {
            if (selectedElements.length === 0) return;
            
            selectedElements.forEach(element => {
                const currentZ = parseInt(element.style.zIndex) || 0;
                element.style.zIndex = currentZ + 1;
                
                const elementData = canvasElements.find(el => el.id === element.id);
                if (elementData) {
                    elementData.zIndex = currentZ + 1;
                }
            });
            
            maxZIndex = Math.max(maxZIndex, ...selectedElements.map(el => parseInt(el.style.zIndex) || 0));
            updateElementsData();
            showToast('ÂõæÂ±ÇÂ∑≤‰∏äÁßª', 'success');
        }

        function moveLayerDown() {
            if (selectedElements.length === 0) return;
            
            selectedElements.forEach(element => {
                const currentZ = parseInt(element.style.zIndex) || 0;
                if (currentZ > 1) {
                    element.style.zIndex = currentZ - 1;
                    
                    const elementData = canvasElements.find(el => el.id === element.id);
                    if (elementData) {
                        elementData.zIndex = currentZ - 1;
                    }
                }
            });
            
            updateElementsData();
            showToast('ÂõæÂ±ÇÂ∑≤‰∏ãÁßª', 'success');
        }

        function moveLayerTop() {
            if (selectedElements.length === 0) return;
            
            maxZIndex++;
            selectedElements.forEach(element => {
                element.style.zIndex = maxZIndex;
                
                const elementData = canvasElements.find(el => el.id === element.id);
                if (elementData) {
                    elementData.zIndex = maxZIndex;
                }
            });
            
            updateElementsData();
            showToast('ÂõæÂ±ÇÂ∑≤ÁΩÆ‰∫éÈ°∂Â±Ç', 'success');
        }

        function moveLayerBottom() {
            if (selectedElements.length === 0) return;
            
            // Â∞ÜÊâÄÊúâÂÖ∂‰ªñÂÖÉÁ¥†‰∏äÁßª
            canvasElements.forEach(el => {
                if (!selectedElements.some(sel => sel.id === el.id)) {
                    el.zIndex = (el.zIndex || 0) + selectedElements.length;
                    const element = document.getElementById(el.id);
                    if (element) {
                        element.style.zIndex = el.zIndex;
                    }
                }
            });
            
            // Â∞ÜÈÄâ‰∏≠ÂÖÉÁ¥†ÁΩÆ‰∫éÂ∫ïÂ±Ç
            selectedElements.forEach((element, index) => {
                element.style.zIndex = index + 1;
                
                const elementData = canvasElements.find(el => el.id === element.id);
                if (elementData) {
                    elementData.zIndex = index + 1;
                }
            });
            
            maxZIndex = Math.max(...canvasElements.map(el => el.zIndex || 0));
            updateElementsData();
            showToast('ÂõæÂ±ÇÂ∑≤ÁΩÆ‰∫éÂ∫ïÂ±Ç', 'success');
        }

        // ÂØπÈΩêÂäüËÉΩ
        function alignLeft() {
            if (selectedElements.length < 2) return;
            const leftmost = Math.min(...selectedElements.map(el => parseInt(el.style.left)));
            const snappedLeftmost = snapToGrid ? snapToGridPoint(leftmost) : leftmost;
            selectedElements.forEach(el => el.style.left = snappedLeftmost + 'px');
            updateElementsData();
        }

        function alignRight() {
            if (selectedElements.length < 2) return;
            const rightmost = Math.max(...selectedElements.map(el => parseInt(el.style.left) + el.offsetWidth));
            selectedElements.forEach(el => {
                const newLeft = rightmost - el.offsetWidth;
                el.style.left = (snapToGrid ? snapToGridPoint(newLeft) : newLeft) + 'px';
            });
            updateElementsData();
        }

        function alignCenter() {
            if (selectedElements.length < 2) return;
            const centerX = selectedElements.reduce((sum, el) => sum + parseInt(el.style.left) + el.offsetWidth / 2, 0) / selectedElements.length;
            const snappedCenterX = snapToGrid ? snapToGridPoint(centerX) : centerX;
            selectedElements.forEach(el => el.style.left = (snappedCenterX - el.offsetWidth / 2) + 'px');
            updateElementsData();
        }

        function alignTop() {
            if (selectedElements.length < 2) return;
            const topmost = Math.min(...selectedElements.map(el => parseInt(el.style.top)));
            const snappedTopmost = snapToGrid ? snapToGridPoint(topmost) : topmost;
            selectedElements.forEach(el => el.style.top = snappedTopmost + 'px');
            updateElementsData();
        }

        function alignBottom() {
            if (selectedElements.length < 2) return;
            const bottommost = Math.max(...selectedElements.map(el => parseInt(el.style.top) + el.offsetHeight));
            selectedElements.forEach(el => {
                const newTop = bottommost - el.offsetHeight;
                el.style.top = (snapToGrid ? snapToGridPoint(newTop) : newTop) + 'px';
            });
            updateElementsData();
        }

        function alignMiddle() {
            if (selectedElements.length < 2) return;
            const centerY = selectedElements.reduce((sum, el) => sum + parseInt(el.style.top) + el.offsetHeight / 2, 0) / selectedElements.length;
            const snappedCenterY = snapToGrid ? snapToGridPoint(centerY) : centerY;
            selectedElements.forEach(el => el.style.top = (snappedCenterY - el.offsetHeight / 2) + 'px');
            updateElementsData();
        }

        function distributeHorizontal() {
            if (selectedElements.length < 3) return;
            const sorted = [...selectedElements].sort((a, b) => parseInt(a.style.left) - parseInt(b.style.left));
            const totalWidth = parseInt(sorted[sorted.length - 1].style.left) + sorted[sorted.length - 1].offsetWidth - parseInt(sorted[0].style.left);
            const elementWidth = sorted.reduce((sum, el) => sum + el.offsetWidth, 0);
            let spacing = (totalWidth - elementWidth) / (sorted.length - 1);
            
            // Â∫îÁî®ÁΩëÊ†ºÊçïÊçâÂà∞Èó¥Ë∑ù
            if (snapToGrid) {
                spacing = snapToGridPoint(spacing);
            }
            
            let currentX = parseInt(sorted[0].style.left);
            sorted.forEach((el, index) => {
                if (index > 0) {
                    currentX += sorted[index - 1].offsetWidth + spacing;
                    el.style.left = (snapToGrid ? snapToGridPoint(currentX) : currentX) + 'px';
                }
            });
            updateElementsData();
        }

        function distributeVertical() {
            if (selectedElements.length < 3) return;
            const sorted = [...selectedElements].sort((a, b) => parseInt(a.style.top) - parseInt(b.style.top));
            const totalHeight = parseInt(sorted[sorted.length - 1].style.top) + sorted[sorted.length - 1].offsetHeight - parseInt(sorted[0].style.top);
            const elementHeight = sorted.reduce((sum, el) => sum + el.offsetHeight, 0);
            let spacing = (totalHeight - elementHeight) / (sorted.length - 1);
            
            // Â∫îÁî®ÁΩëÊ†ºÊçïÊçâÂà∞Èó¥Ë∑ù
            if (snapToGrid) {
                spacing = snapToGridPoint(spacing);
            }
            
            let currentY = parseInt(sorted[0].style.top);
            sorted.forEach((el, index) => {
                if (index > 0) {
                    currentY += sorted[index - 1].offsetHeight + spacing;
                    el.style.top = (snapToGrid ? snapToGridPoint(currentY) : currentY) + 'px';
                }
            });
            updateElementsData();
        }

        function alignToCanvas() {
            if (selectedElements.length === 0) return;
            const canvas = document.getElementById('canvas');
            const canvasWidth = canvas.offsetWidth;
            const canvasHeight = canvas.offsetHeight;
            
            selectedElements.forEach(el => {
                let newLeft = (canvasWidth - el.offsetWidth) / 2;
                let newTop = (canvasHeight - el.offsetHeight) / 2;
                
                // Â∫îÁî®ÁΩëÊ†ºÊçïÊçâ
                if (snapToGrid) {
                    newLeft = snapToGridPoint(newLeft);
                    newTop = snapToGridPoint(newTop);
                }
                
                el.style.left = newLeft + 'px';
                el.style.top = newTop + 'px';
            });
            updateElementsData();
        }

        // Êõ¥Êñ∞ÂÖÉÁ¥†Êï∞ÊçÆ
        function updateElementsData() {
            selectedElements.forEach(element => {
                const elementData = canvasElements.find(el => el.id === element.id);
                if (elementData) {
                    elementData.x = parseInt(element.style.left);
                    elementData.y = parseInt(element.style.top);
                    elementData.width = parseInt(element.style.width);
                    elementData.height = parseInt(element.style.height);
                    elementData.zIndex = parseInt(element.style.zIndex) || 0;
                }
            });
        }

        // Êõ¥Êñ∞ÂÖÉÁ¥†ÂàóË°®
        function updateElementsList() {
            const list = document.getElementById('elements-list');
            if (canvasElements.length === 0) {
                list.innerHTML = '<p style="color: #999; text-align: center; padding: 1rem;">ÊöÇÊó†ÂÖÉÁ¥†</p>';
                return;
            }
            
            // Êåâz-indexÊéíÂ∫èÊòæÁ§∫
            const sortedElements = [...canvasElements].sort((a, b) => (b.zIndex || 0) - (a.zIndex || 0));
            
            list.innerHTML = sortedElements.map((el, index) => {
                const isSelected = selectedElements.some(sel => sel.id === el.id);
                return `
                    <div class="element-item ${isSelected ? 'selected' : ''}" data-id="${el.id}" onclick="selectElementById('${el.id}')">
                        <div class="element-info">
                            <span>üñºÔ∏è</span>
                            <span>${el.name || 'ÂõæÁâá ' + (index + 1)}</span>
                        </div>
                        <span class="element-layer">L${el.zIndex || 0}</span>
                        <button class="delete-btn" onclick="deleteElement('${el.id}', event)">Âà†Èô§</button>
                    </div>
                `;
            }).join('');
        }

        // ÈÄöËøáIDÈÄâ‰∏≠ÂÖÉÁ¥†
        function selectElementById(id) {
            const element = document.getElementById(id);
            if (element) {
                selectElement(element);
            }
        }

        // Âà†Èô§ÂÖÉÁ¥†
        function deleteElement(id, event) {
            event.stopPropagation();
            const element = document.getElementById(id);
            if (element) {
                element.remove();
                canvasElements = canvasElements.filter(el => el.id !== id);
                selectedElements = selectedElements.filter(el => el.id !== id);
                boxSelectedElements = boxSelectedElements.filter(el => el.id !== id);
                updateSelectionUI();
                showToast('ÂÖÉÁ¥†Â∑≤Âà†Èô§', 'info');
            }
        }

        // Âà†Èô§ÈÄâ‰∏≠ÁöÑÂÖÉÁ¥†
        function deleteSelected() {
            if (selectedElements.length === 0) {
                showToast('ËØ∑ÂÖàÈÄâÊã©ÂÖÉÁ¥†', 'info');
                return;
            }
            
            selectedElements.forEach(element => {
                element.remove();
                canvasElements = canvasElements.filter(el => el.id !== element.id);
            });
            selectedElements = [];
            boxSelectedElements = [];
            updateSelectionUI();
            showToast('ÈÄâ‰∏≠ÂÖÉÁ¥†Â∑≤Âà†Èô§', 'success');
        }

        // Ê∏ÖÁ©∫ÁîªÂ∏É
        function clearCanvas() {
            if (canvasElements.length === 0) {
                showToast('ÁîªÂ∏ÉÂ∑≤ÁªèÊòØÁ©∫ÁöÑ', 'info');
                return;
            }
            
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÁîªÂ∏ÉÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ')) {
                const canvas = document.getElementById('canvas');
                canvas.querySelectorAll('.canvas-element').forEach(el => el.remove());
                canvasElements = [];
                selectedElements = [];
                boxSelectedElements = [];
                maxZIndex = 0;
                updateSelectionUI();
                showToast('ÁîªÂ∏ÉÂ∑≤Ê∏ÖÁ©∫', 'success');
            }
        }

        // ÂØºÂá∫JSON
        function exportJSON() {
            if (canvasElements.length === 0) {
                showToast('ÁîªÂ∏É‰∏∫Á©∫ÔºåÊó†Ê≥ïÂØºÂá∫', 'error');
                return;
            }
            
            const canvas = document.getElementById('canvas');
            const data = {
                canvasWidth: parseInt(canvas.style.width),
                canvasHeight: parseInt(canvas.style.height),
                elements: canvasElements,
                gridSize: gridSize,
                snapToGrid: snapToGrid,
                timestamp: new Date().toISOString()
            };
            
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `canvas-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('JSONÊñá‰ª∂Â∑≤ÂØºÂá∫', 'success');
        }

        // ÂØºÂÖ•JSON
        function handleJSONImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = JSON.parse(event.target.result);
                    restoreCanvas(data);
                    showToast('ÁîªÂ∏ÉÂ∑≤ÊÅ¢Â§ç', 'success');
                } catch (error) {
                    showToast('JSONÊñá‰ª∂Ê†ºÂºèÈîôËØØ', 'error');
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        }

        // ÊÅ¢Â§çÁîªÂ∏É
        function restoreCanvas(data) {
            const canvas = document.getElementById('canvas');
            canvas.querySelectorAll('.canvas-element').forEach(el => el.remove());
            canvasElements = [];
            selectedElements = [];
            boxSelectedElements = [];
            maxZIndex = 0;
            
            // ÊÅ¢Â§çÁΩëÊ†ºËÆæÁΩÆ
            if (data.gridSize !== undefined) {
                gridSize = data.gridSize;
                document.getElementById('grid-size').value = gridSize;
            }
            
            if (data.snapToGrid !== undefined) {
                snapToGrid = data.snapToGrid;
                const snapToggle = document.getElementById('snap-toggle');
                if (snapToGrid) {
                    snapToggle.classList.add('active');
                } else {
                    snapToggle.classList.remove('active');
                }
            }
            
            if (data.canvasWidth && data.canvasHeight) {
                document.getElementById('canvas-width').value = data.canvasWidth;
                document.getElementById('canvas-height').value = data.canvasHeight;
                resizeCanvas();
            }
            
            data.elements.forEach(elementData => {
                const element = document.createElement('div');
                element.className = 'canvas-element';
                element.id = elementData.id;
                element.style.width = elementData.width + 'px';
                element.style.height = elementData.height + 'px';
                element.style.left = elementData.x + 'px';
                element.style.top = elementData.y + 'px';
                element.style.zIndex = elementData.zIndex || 0;
                
                element.innerHTML = `
                    <img src="${elementData.src}" alt="${elementData.name}">
                    <div class="resize-handle nw"></div>
                    <div class="resize-handle ne"></div>
                    <div class="resize-handle sw"></div>
                    <div class="resize-handle se"></div>
                `;
                
                canvas.appendChild(element);
                bindElementEvents(element);
                
                // Á°Æ‰øùÊâÄÊúâÂøÖË¶ÅÂ≠óÊÆµÈÉΩÂ≠òÂú®
                const completeElementData = {
                    ...elementData,
                    originalName: elementData.originalName || elementData.name,
                    originalWidth: elementData.originalWidth || elementData.width,
                    originalHeight: elementData.originalHeight || elementData.height
                };
                
                canvasElements.push(completeElementData);
                
                const idNum = parseInt(elementData.id.split('-')[1]);
                if (idNum > elementIdCounter) {
                    elementIdCounter = idNum;
                }
                
                if (elementData.zIndex > maxZIndex) {
                    maxZIndex = elementData.zIndex;
                }
            });
            
            updateSelectionUI();
            updateGridDisplay();
        }

        // ÂØºÂá∫ÁîªÂ∏É‰∏∫ÂõæÁâá
        function exportCanvas() {
            const canvas = document.getElementById('canvas');
            const exportCanvas = document.createElement('canvas');
            const ctx = exportCanvas.getContext('2d');
            
            exportCanvas.width = parseInt(canvas.style.width);
            exportCanvas.height = parseInt(canvas.style.height);
            
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
            
            let loadedImages = 0;
            const totalImages = canvasElements.length;
            
            if (totalImages === 0) {
                showToast('ÁîªÂ∏É‰∏∫Á©∫ÔºåÊó†Ê≥ïÂØºÂá∫', 'error');
                return;
            }
            
            // Êåâz-indexÊéíÂ∫èÂØºÂá∫
            const sortedElements = [...canvasElements].sort((a, b) => (a.zIndex || 0) - (b.zIndex || 0));
            
            sortedElements.forEach(elementData => {
                const img = new Image();
                img.onload = function() {
                    ctx.drawImage(img, elementData.x, elementData.y, elementData.width, elementData.height);
                    loadedImages++;
                    
                    if (loadedImages === totalImages) {
                        exportCanvas.toBlob(function(blob) {
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `canvas-${Date.now()}.png`;
                            a.click();
                            URL.revokeObjectURL(url);
                            showToast('ÁîªÂ∏ÉÂ∑≤ÂØºÂá∫‰∏∫ÂõæÁâá', 'success');
                        });
                    }
                };
                img.src = elementData.src;
            });
        }

        // ÊòæÁ§∫ÊèêÁ§∫Ê∂àÊÅØ
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const msg = document.getElementById('toast-message');
            
            toast.className = 'toast ' + type;
            msg.textContent = message;
            
            switch(type) {
                case 'success':
                    icon.textContent = '‚úÖ';
                    break;
                case 'error':
                    icon.textContent = '‚ùå';
                    break;
                case 'info':
                    icon.textContent = '‚ÑπÔ∏è';
                    break;
            }
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
